FROM python:3.5.5-alpine

ARG DOCKER_CONTAINER_TEST_RESULT_DIRECTORY

ENV DOCKER_CONTAINER_TEST_RESULT_DIRECTORY=$DOCKER_CONTAINER_TEST_RESULT_DIRECTORY

ARG UNIT_TEST_RESULTS

ENV UNIT_TEST_RESULTS=$UNIT_TEST_RESULTS

WORKDIR $DOCKER_CONTAINER_TEST_RESULT_DIRECTORY

COPY test-requirements.txt ./
COPY requirements.txt ./

COPY wall_e ./

COPY pytest.ini ./

COPY setup.cfg ./

RUN pip install --no-cache-dir -r test-requirements.txt

# being done because of https://github.com/psycopg/psycopg2/issues/684
RUN cat requirements.txt  | grep -v "psycopg2-binary" > requirements.txt
RUN apk add freetype-dev && apk add postgresql-dev && pip install --no-cache-dir -r requirements.txt &&  apk --update add postgresql-client

RUN pip install --no-cache-dir psycopg2

RUN mkdir -p $UNIT_TEST_RESULTS

CMD ["sh" , "-c", "py.test --junitxml=${UNIT_TEST_RESULTS}/all-unit-tests.xml" ]
